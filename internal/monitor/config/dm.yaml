# 达梦数据库监控指标配置
metrics:
  # 运行时长指标
  - context: uptime
    labels: ["version"]
    metricsdesc:
      seconds: "Gauge metric with uptime of database in seconds."
    metricstype:
      seconds: gauge
    request: |
      SELECT * FROM V$INSTANCE

  # 会话连接数指标
  - context: sessions
    labels: []
    metricsdesc:
      active: "Gauge metric with count of active sessions."
      idle: "Gauge metric with count of idle sessions."
      total: "Gauge metric with total number of sessions."
    metricstype:
      active: gauge
      idle: gauge
      total: gauge
    request: |
      SELECT
        SUM(CASE WHEN STATE = 'ACTIVE' THEN 1 ELSE 0 END) AS active,
        SUM(CASE WHEN STATE = 'IDLE' THEN 1 ELSE 0 END) AS idle,
        COUNT(*) AS total
      FROM V$SESSIONS

  # 最大连接数指标
  - context: connections
    labels: []
    metricsdesc:
      max_connections: "Gauge metric with maximum allowed connections."
      current_connections: "Gauge metric with current number of connections."
      available_connections: "Gauge metric with available connections."
    metricstype:
      max_connections: gauge
      current_connections: gauge
      available_connections: gauge
    request: |
      SELECT
        (SELECT PARA_VALUE FROM V$DM_INI WHERE PARA_NAME = 'MAX_SESSIONS') AS max_connections,
        (SELECT COUNT(*) FROM V$SESSIONS) AS current_connections,
        CAST((SELECT PARA_VALUE FROM V$DM_INI WHERE PARA_NAME = 'MAX_SESSIONS') AS INT) -
          (SELECT COUNT(*) FROM V$SESSIONS) AS available_connections