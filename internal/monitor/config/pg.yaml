# PostgreSQL 数据库监控指标配置
metrics:
  # 运行时长指标
  - context: uptime
    labels: ["version"]
    metricsdesc:
      seconds: "Gauge metric with uptime of database in seconds."
    metricstype:
      seconds: gauge
    request: |
      SELECT version() AS version,
             EXTRACT(EPOCH FROM (clock_timestamp() - pg_postmaster_start_time()))::bigint AS seconds

  # 会话连接数指标
  - context: sessions
    labels: ["datname"]
    metricsdesc:
      active: "Gauge metric with count of sessions by state active."
      idle: "Gauge metric with count of sessions by state idle."
      total: "Gauge metric with total number of sessions."
    metricstype:
      active: gauge
      idle: gauge
      total: gauge
    request: |
      SELECT COALESCE(datname, 'unknown')::text AS datname,
             COUNT(*) FILTER (WHERE state = 'active') AS active,
             COUNT(*) FILTER (WHERE state = 'idle') AS idle,
             COUNT(*) AS total
      FROM pg_stat_activity
      WHERE datname IS NOT NULL
      GROUP BY datname

  # 最大连接数指标
  - context: connections
    labels: []
    metricsdesc:
      max_connections: "Gauge metric with maximum allowed connections."
      current_connections: "Gauge metric with current number of connections."
      available_connections: "Gauge metric with available connections."
    metricstype:
      max_connections: gauge
      current_connections: gauge
      available_connections: gauge
    request: |
      SELECT
        setting::integer AS max_connections,
        (SELECT COUNT(*) FROM pg_stat_activity WHERE state IS NOT NULL) AS current_connections,
        setting::integer -
          (SELECT COUNT(*) FROM pg_stat_activity WHERE state IS NOT NULL) AS available_connections
      FROM pg_settings
      WHERE name = 'max_connections'

  # 数据库状态指标
  - context: database
    labels: ["datname"]
    metricsdesc:
      commit_count: "Counter metric with commit of database by statement."
      rollback_count: "Counter metric with rollback of database by statement."
      numbackends: "Gauge metric with number of backends currently connected."
    metricstype:
      commit_count: counter
      rollback_count: counter
      numbackends: gauge
    request: |
      SELECT datname::text AS datname,
             xact_commit::bigint AS commit_count,
             xact_rollback::bigint AS rollback_count,
             numbackends::bigint AS numbackends
      FROM pg_stat_database
      WHERE datname NOT IN ('template0', 'template1', 'template2')